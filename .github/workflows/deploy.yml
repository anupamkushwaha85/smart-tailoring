name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: pdo, pdo_mysql, mysqli, mbstring, openssl
          coverage: none
      
      - name: Validate composer.json
        run: composer validate --strict
      
      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-suggest
      
      - name: Check PHP syntax
        run: find . -name "*.php" ! -path "./vendor/*" -exec php -l {} \;
      
      - name: Create test .env file
        run: |
          cp .env.example .env
          echo "DB_HOST=localhost" >> .env
          echo "DB_NAME=smart_tailoring_test" >> .env
          echo "DB_USER=root" >> .env
          echo "DB_PASS=" >> .env
      
      - name: Setup MySQL
        run: |
          sudo systemctl start mysql
          mysql -uroot -proot -e "CREATE DATABASE smart_tailoring_test CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
      
      - name: Run database migrations
        run: php database/migrate.php run
      
      - name: Test database connection
        run: php -r "require 'vendor/autoload.php'; require 'config/db.php'; if (isset(\$conn) && \$conn instanceof mysqli) { echo 'Database connected successfully'; } else { echo 'Database connection failed'; exit(1); }"
